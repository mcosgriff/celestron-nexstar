name: Sync Wiki from Documentation

on:
  push:
    branches: [main]
    paths:
      - 'docs/**/*.md'
      - 'README.md'
      - '.github/workflows/wiki-sync.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  sync-wiki:
    name: Sync Documentation to Wiki
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push to wiki

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Checkout wiki repository
        uses: actions/checkout@v4
        with:
          repository: mcosgriff/celestron-nexstar.wiki
          path: wiki
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync documentation files
        run: |
          cd repo

          # Define file mappings: source_file -> wiki_file
          # Format: "source:destination"
          declare -A file_map=(
            ["docs/INSTALL.md"]="Installation.md"
            ["docs/CLI.md"]="CLI-Reference.md"
            ["docs/CATALOG_DATA_SOURCES.md"]="Catalog-Data-Sources.md"
            ["docs/DATA_IMPORT.md"]="Data-Import.md"
            ["docs/CUSTOM_CATALOG.md"]="Custom-Catalogs.md"
            ["docs/CUSTOM_YAML_FEATURE.md"]="Custom-YAML-Catalogs.md"
            ["docs/TUI_FRAMEWORK_OPTIONS.md"]="TUI-Framework.md"
            ["docs/INDEX.md"]="API-Index.md"
            ["docs/COSMOS_INTEGRATION.md"]="COSMOS-Integration.md"
            ["docs/ORGANIZATION.md"]="Project-Organization.md"
          )

          # Track which wiki files should exist
          expected_wiki_files=()

          # Sync mapped files
          for source_file in "${!file_map[@]}"; do
            wiki_file="${file_map[$source_file]}"
            expected_wiki_files+=("$wiki_file")

            if [ -f "$source_file" ]; then
              echo "Syncing $source_file -> $wiki_file"
              cp "$source_file" "../wiki/$wiki_file"
            else
              echo "Warning: $source_file not found"
              # Delete corresponding wiki file if source is missing
              if [ -f "../wiki/$wiki_file" ]; then
                echo "Deleting wiki page $wiki_file (source file deleted)"
                rm "../wiki/$wiki_file"
              fi
            fi
          done

          # Note: Deletions are handled above - when a source file doesn't exist,
          # we delete the corresponding wiki file. Protected files are handled
          # by not deleting them even if their source is missing.

          # Handle README.md -> Home.md separately
          # Check if README.md was changed in this commit
          readme_changed=false
          if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "^README.md$"; then
            readme_changed=true
          fi

          # Update Home.md if README changed or if it doesn't exist
          if [ "$readme_changed" = true ] || [ ! -f ../wiki/Home.md ]; then
            echo "Updating Home.md from README.md"
            # Create a wiki-friendly Home.md from README.md
            # Adjust relative links for wiki context (remove docs/ prefix)
            sed 's|(docs/|(|g; s|docs/||g; s|\.md)|)|g' README.md > ../wiki/Home.md.tmp
            # Use first 150 lines (or full file if shorter) to keep it concise
            head -150 ../wiki/Home.md.tmp > ../wiki/Home.md
            rm ../wiki/Home.md.tmp
          else
            echo "README.md unchanged, keeping existing Home.md"
          fi

          echo "✓ Documentation files synced"

      - name: Commit and push wiki changes
        run: |
          cd wiki

          # Check if there are any changes (including deletions)
          if [ -n "$(git status --porcelain)" ]; then
            # Stage all changes including deletions
            git add -A .

            # Get list of changed files (added, modified, deleted)
            changed_files=$(git diff --cached --name-status)
            added_files=$(echo "$changed_files" | grep "^A" | cut -c3- || true)
            modified_files=$(echo "$changed_files" | grep "^M" | cut -c3- || true)
            deleted_files=$(echo "$changed_files" | grep "^D" | cut -c3- || true)

            # Build commit message
            commit_msg="Auto-sync documentation from main repository"

            if [ -n "$added_files" ]; then
              commit_msg="$commit_msg"$'\n\n'"Added files:"$'\n'"$(echo "$added_files" | sed 's/^/- /')"
            fi

            if [ -n "$modified_files" ]; then
              commit_msg="$commit_msg"$'\n\n'"Modified files:"$'\n'"$(echo "$modified_files" | sed 's/^/- /')"
            fi

            if [ -n "$deleted_files" ]; then
              commit_msg="$commit_msg"$'\n\n'"Deleted files:"$'\n'"$(echo "$deleted_files" | sed 's/^/- /')"
            fi

            commit_msg="$commit_msg"$'\n\n'"[skip ci]"

            git commit -m "$commit_msg"
            git push origin master
            echo "✓ Wiki updated successfully"

            # Add summary
            echo "## Wiki Sync Summary" >> $GITHUB_STEP_SUMMARY
            if [ -n "$added_files" ]; then
              echo "### Added:" >> $GITHUB_STEP_SUMMARY
              echo "$added_files" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$modified_files" ]; then
              echo "### Modified:" >> $GITHUB_STEP_SUMMARY
              echo "$modified_files" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$deleted_files" ]; then
              echo "### Deleted:" >> $GITHUB_STEP_SUMMARY
              echo "$deleted_files" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No changes to sync"
            echo "No changes detected in documentation files." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Wiki Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Documentation files have been synced to the wiki." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Files synced:" >> $GITHUB_STEP_SUMMARY
          cd wiki
          git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "No changes" >> $GITHUB_STEP_SUMMARY
